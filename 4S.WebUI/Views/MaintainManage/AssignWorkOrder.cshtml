
@{
    ViewBag.Title = "AssignWorkOrder";
    Layout = "~/Views/Shared/_LayouthomePage.cshtml";
}


<div class="layui-fluid">

    <fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px;">
        <legend>工单派工</legend>
    </fieldset>
    <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15" id="total">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">工单信息</div>
                    <div class="layui-card-body">

                        <form class="layui-form layui-form-pane" action="">
                            <div class="layui-form-item">
                                <label class="layui-form-label">工单号</label>
                                <div class="layui-input-inline">
                                    <input id="maintainOrderNum" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">预约单号</label>
                                <div class="layui-input-inline">
                                    <input id="appointOrderNum" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">车辆编号</label>
                                <div class="layui-input-inline">
                                    <input id="carNum" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">客户姓名</label>
                                <div class="layui-input-inline">
                                    <input id="cusName" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">手机号</label>
                                <div class="layui-input-inline">
                                    <input id="phone" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">创建时间</label>
                                <div class="layui-input-inline">
                                    <input id="createTime" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>

                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">创建员工</label>
                                <div class="layui-input-inline">
                                    <input id="createStaff" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>

                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">故障描述</label>
                                <div class="layui-input-block">
                                    <textarea placeholder="请输入内容" class="layui-textarea" id="descript"></textarea>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">预计项目</label>
                                <div class="layui-input-block">
                                    <textarea placeholder="请输入内容" class="layui-textarea" id="expectedPj"></textarea>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">预计价格</label>
                                <div class="layui-input-inline">
                                    <input id="expectedPrice" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">预计时间</label>
                                <div class="layui-input-inline">
                                    <input id="expectedTime" type="text" name="staffname" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">

                                <div class="layui-inline settime">
                                    <label class="layui-form-label">完成时间</label>
                                    <div class="layui-input-inline">
                                        <input type="text" class="layui-input ordertime" placeholder="yyyy-MM-dd HH:mm:ss">
                                    </div>
                                </div>



                            </div>
                            <input type="button" class="layui-btn layui-btn-radius layui-btn-normal" value="添加项目" id="addPJ" />
                            <input value="0" type="hidden" id="orderId" />
                        </form>

                    </div>
                </div>
            </div>

            

        </div>
        <form class="layui-form">
            <div class="layui-row layui-col-space15 projects">


                <div class="project" style="display:none;">

                    <div class="layui-col-md9 PJitem">

                        <div class="layui-card">
                            <div class="layui-card-header">
                                <span>添加项目</span>
                                <button type="button" style="right:25px;" onclick="deleteProject(this)"><i class="layui-icon"></i></button>


                            </div>
                            <div class="layui-card-body">

                                <div class="layui-form-item">

                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width:114px">维修项目</label>
                                        <div class="layui-input-inline">
                                            <select name="modules" lay-verify="required" lay-search="" class="pjselect">
                                                <option value="">直接选择或搜索选择</option>
                                            </select>
                                        </div>


                                    </div>



                                </div>
                                <div class="layui-form-item">

                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width:114px">维修小组</label>
                                        <div class="layui-input-inline">
                                            <select name="modules" lay-verify="required" lay-search="" class="dpselect">
                                                <option value="">直接选择或搜索选择</option>
                                            </select>
                                        </div>


                                    </div>
                                    <div class="layui-inline settime">

                                    </div>


                                </div>

                                    



                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width:114px">维修零件</label>
                                        <div class="layui-input-inline">
                                            <select class="pselect1" lay-filter="pselect1" name="modules" lay-verify="required" lay-search="">
                                                <option value="">直接选择或搜索选择</option>
                                            </select>
                                        </div>
                                        <div class="layui-input-inline">
                                            <select class="pselect2" lay-filter="pselect2" name="modules" lay-verify="required" lay-search="">
                                                <option value="">直接选择或搜索选择</option>
                                            </select>
                                        </div>
                                        <div class="layui-input-inline">
                                            <select class="pselect3" lay-filter="pselect3" name="modules" lay-verify="required" lay-search="">
                                                <option value="">直接选择或搜索选择</option>
                                            </select>
                                        </div>


                                    </div>



                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width:114px">零件数量</label>
                                        <div class="layui-input-inline">
                                            <input type="text" placeholder="请输入数量" class="layui-input pinput" />
                                        </div>
                                        <button type="button" class="layui-btn" onclick="addPart(this)">
                                            <i class="layui-icon">&#xe608;</i> 添加
                                        </button>
                                    </div>
                                </div>
                                <div class="layui-form-item parts">

                                    <div class="part" style="display:none;">
                                        <div class="Pitem" style="margin: 5px 10px 5px 40px;">
                                            <input class="pid" value="0" type="hidden" />
                                            <label class="pname" style="padding: 10px 10px;">名称</label>
                                            <label class="pnum" style="position: absolute;left: 260px;margin-top: 10px;">数量</label>
                                            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm" style="position: absolute;left: 300px;margin-top: 7px;" onclick="deletePart(this)"><i class="layui-icon"></i></button>

                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">

                                </div>

                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </form>
        
            </div>

    

        </div>
<button onclick="numeric()">数量</button>
        <div style="margin-top: 20px;">
            <div style="margin-left:50px;margin-top:10px;margin-bottom:10px;">
                <input type="button" class="layui-btn layui-btn-radius layui-btn-normal" value="派工" onclick="check()" />
                &nbsp;&nbsp;&nbsp;
                <input type="button" class="layui-btn layui-btn-radius layui-btn-primary" value="返回" onclick="goback()" />
            </div>
        </div>
<script>
    function render() {
        layui.use('form', function () {
            var form = layui.form;
    
            form.render();
        });
    }
 

    layui.use(['form','laydate'], function () {
        var form = layui.form;
        var laydate = layui.laydate;
        form.on('select(pselect1)', function (data) {
            var item = data.elem;
            $.post('/DepartManage/ClassSelect', { num: data.value }, function (res) {
                var htmls = "";
                for (var x in res) {
                    htmls += '<option value = "' + res[x].classID + '">' + res[x].className + '</option>';
                }
                $(item).parent().parent().find(".pselect2").html(htmls);
                $(item).parent().parent().find(".pselect3").html("");
                
                render();

            });


        });
        form.on('select(pselect2)', function (data) {
            var item = data.elem;
            $.post('/MaintainManage/PartSelect', { id: data.value }, function (res) {
                var htmls = "";
                for (var x in res) {
                    htmls += '<option value = "' + res[x].partID + '">' + res[x].partName + '</option>';
                }
                $(item).parent().parent().find(".pselect3").html(htmls);

                render();
            })
        });

        function setTime(){
            $('.ordertime').each(function(){
                laydate.render({
                    elem:this,
                    trigger:"click",
                    type:'datetime',
                    format:'yyyy/M/d H:m:s'
                });
            });
        }
        setTime();
        $("#addPJ").click(function(){
            var time = "<label class='layui-form-label' style='width:114px;'>完成时间</label>"+
                                        "<div class='layui-input-inline'>"+
                                            "<input type='text' class='layui-input ordertime' placeholder='yyyy-MM-dd HH:mm:ss'>"+
                                        "</div>"
            var content = $('.project').html();
            $('.projects').append(content);
            $('.projects').find('.settime').last().append(time);
            form.render();
            setTime();
        })


 
    });

</script>
        <script>
            function numeric() {
                alert($('.PJitem').length);
            }
            
            $("#name").bind('input porpertychange', function () {
                console.log("e");
            });
            function addProject() {
  
                var content = $('.project').html();
                $('.projects').append(content);
                render();
               
                
                
            }
         
            function deleteProject(obj) {
                layer.confirm('确定删除吗?', { icon: 3, title: '提示' }, function (index) {
                    //do something
                    var Index = $(obj).parent().parent().parent().index();
                    $(obj).parent().parent().parent().remove();
                    layer.close(index);
                    layer.msg(Index);
                });
                
            }
            function addPart(obj) {
                var id = $(obj).parent().parent().prev().find('.pselect3').val();
                var name = $(obj).parent().parent().prev().find('.pselect3').find('option:selected').text();
                var num = $(obj).prev().find('.pinput').val();
                $('.part').find('.pid').val(id);
                $('.part').find('.pname').text(name);
                $('.part').find('.pnum').text(num);
                var content = $('.part').html();  
                $(obj).parent().parent().next().append(content);
                render();
            }

            function deletePart(obj) {
                var Index = $(obj).parent().index();
                layer.msg(Index);
                $(obj).parent().remove();
            }


            loadData();

            function loadData() {
                
                $.post('/MaintainManage/LoadWorkOrder', {id : @ViewBag.id}, function (res) {
                    var project = res.model.pj;
                    var depart = res.model.dp;
                    var partclass = res.model.pc;
                    var htmls1 = "";
                    var htmls2 = "";
                    var htmls3 = "";
                    for (var x in project) {
                        htmls1 += '<option value = "' + project[x].projectID + '">' + project[x].projectName + '</option>';
                    }
                    for (var x in depart) {
                        htmls2 += '<option value = "' + depart[x].departID + '">' + depart[x].departName + '</option>';
                    }
                    for (var x in partclass) {
                        htmls3 += '<option value = "' + partclass[x].classNum + '">' + partclass[x].className + '</option>';
                    }
                    $(".project:hidden").find(".pjselect").html(htmls1);
                    $(".project:hidden").find(".dpselect").html(htmls2);
                    $(".project:hidden").find(".pselect1").html(htmls3);
                    
                    $("#orderId").val(res.maintainOrderID);
                    $("#maintainOrderNum").val(res.maintainOrderNum);
                    $("#appointOrderNum").val(res.appointOrderNum);
                    $("#carNum").val(res.carNum);
                    $("#cusName").val(res.customerName);
                    $("#phone").val(res.customerPhone);
                    $("#createTime").val(res.createTime);
                    $("#createStaff").val(res.createStaff);
                    $("#descript").val(res.faultDescript);
                    $("#expectedPj").val(res.expectedPj);
                    $("#expectedPrice").val(res.expectedPrice);
                    $("#expectedTime").val(res.expectedTime);
                    render();
                });

            }

            function goback() {
                window.location.href = "/MaintainManage/MaintainorderIndex";
            }

            function check() {
                var projects = new Array();
                $(".projects").children(".PJitem").each(function(){
                    var i = $(this).index()-1;
                    var project = new Object();
                    var parts = new Array();
                    project.pjId = $(this).find(".pjselect").val();
                    project.dpId = $(this).find(".dpselect").val();
                    project.time = $(this).find(".ordertime").val();
                    $(this).find(".parts").children(".Pitem").each(function(){
                        var index = $(this).index()-1;
                        var Id = $(this).find(".pid").val();
                        var Amount = $(this).find(".pnum").text();
                        var part = {partId: Id, amount:Amount};
                        parts[index] = part;
                    });
                    project.parts = parts;
                    projects[i] = project;

                });
                var order = JSON.stringify(projects);
                $.post('/maintainManage/AddWorkOrderResult', { orders: order, id : $("#orderId").val()
                }, function (res) {
                    console.log(res);
                    if (res == 1) {
                        setTimeout(function () {
                            layer.msg("添加成功！");
                            window.location.href = "/DepartManage/PartManageIndex";
                        }, 500);

                    }
                    else if (res == 0) {
                        layer.msg("添加失败，请重试。");
                    }
                });
            }
            function load(value) {
                $.post('/DepartManage/PositionSelect', { id: value }, function (res) {
                    console.log(value);
                    var result = res.data;
                    var htmls = "";
                    for (var x in result) {
                        htmls += '<option value = "' + result[x].classNum + '">' + result[x].className + '</option>';
                    }
                    $("#position").html(htmls);
                    render();

                });
            }

        </script>
        <script>
            var app = new Vue({
                el: "#app",
                data: {
                    message: "Hello Vue!"
                }
            });
            var app2 = new Vue({
                el: '#app-2',
                data: {
                    message: "页面加载与" + new Date().toLocaleString()
                }
            });
            var app3 = new Vue({
                el: "#app-3",
                data: {
                    seen: true
                }
            });
            var app4 = new Vue({
                el: '#app-4',
                data: {
                    todos: [
                        { text: "今天开始好好学习" },
                        { text: "我也要好好学习" },
                        { text: "我也是" }
                    ]
                }
            });
            var app5 = new Vue({
                el: '#app-5',
                data: {
                    message: "Hello Vue.js!"
                },
                methods: {
                    reverseMessage: function () {
                        this.message = this.message.split('').reverse().join('')
                    }
                }
            });
            var app6 = new Vue({
                el: "#app-6",
                data: {
                    message: "hello"
                }
            })
        </script>

